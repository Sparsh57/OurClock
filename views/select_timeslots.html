<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Timeslot Picker</title>
  <!-- Materialize CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      background: #f5f5f5;
      font-family: 'Poppins', sans-serif;
    }
    h4 {
      text-align: center;
      color: #1a237e;
      margin: 24px 0;
    }
    #controls-col { padding-right: 1px; }
    /* GRID for timeslots */
    #slots-col {
      padding-left: 70px;
      padding-right: 70px;
    }
    #timeslots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      /* optional: constrain height and scroll if you still want scrolling */
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      justify-items: center;
    }

    /* Timeslot card tweaks */
    .timeslot { margin-bottom: 0; }  /* grid gap handles spacing now */
    .timeslot .card { overflow: visible; }
    .timeslot.invalid input { border-color: #e53935 !important; }

    /* Controls panel */
    #controls .card-panel { padding: 16px; }
    #controls h6 {
      margin-bottom: 16px;
      font-weight: 500;
      color: #1a237e;
    }
    /* Floating add button sizing */
    #controls {
        display: flex;
        justify-content: center;  /* center horizontally */
        flex-wrap: wrap;          /* wrap on small screens */
        gap: 12px;                /* space between buttons */
        margin: 0 auto 24px;      /* vertical spacing */
    }

    /* optional: give a bit of bottomâ€‘margin on each button */
    #controls .btn,
    #controls .btn-floating {
        margin-bottom: 1px;
    }

    /* Full-width text buttons */
    .full-width {
      width: 100%;
      margin-bottom: 12px;
      text-transform: none;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar-fixed">
    {% include 'navigation.html' %}
  </div>

  <h4>Timeslot Picker</h4>
  <div id="controls">
    <button id="add-slot" class="btn blue darken-1"><i class="material-icons left">add</i>Add Slot</button>
    <button id="clear-all" class="btn grey lighten-1"><i class="material-icons left">delete_sweep</i>Clear All</button>
    <button id="import-json" class="btn green lighten-1"><i class="material-icons left">upload</i>Import JSON</button>
    <button id="export-json" class="btn blue lighten-1"><i class="material-icons left">download</i>Export JSON</button>
    <button id="submit" class="btn waves-effect waves-light indigo"><i class="material-icons left">send</i>Submit</button>
    <input type="file" id="file-input" accept=".json" style="display:none">
  </div>

  <!-- Timeslots GRID -->
  <div id="slots-col" class="col s12 m8 l9">
    <div id="timeslots"></div>
  </div>

  <!-- Materialize JS + SortableJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Initialize tooltips
      M.Tooltip.init(document.querySelectorAll('.tooltipped'));

      const daysOfWeek = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      const container  = document.getElementById('timeslots');

      // Make the grid draggable
      Sortable.create(container, { handle: '.drag-handle', animation: 150 });

      function makeSlot({day='', start='', end=''}={}) {
        const el = document.createElement('div');
        el.className = 'timeslot';
        el.innerHTML = `
          <div class="card">
            <div class="card-content">
              <div class="row" style="margin-bottom:8px;">
                <div class="input-field col s4">
                  <select class="browser-default day-select">
                    ${daysOfWeek.map(d=>`<option value="${d}" ${d===day?'selected':''}>${d}</option>`).join('')}
                  </select>
                </div>
                <div class="input-field col s4">
                  <input type="time" class="start-time" value="${start}"><label class="active">Start Time</label>
                </div>
                <div class="input-field col s4">
                  <input type="time" class="end-time" value="${end}"><label class="active">End Time</label>
                </div>
              </div>
              <div class="row" style="margin-bottom:0;">
                <button class="btn red lighten-1 delete-btn"><i class="material-icons">delete</i></button>
                <button class="btn grey lighten-1 duplicate-btn"><i class="material-icons">content_copy</i></button>
              </div>
            </div>
          </div>`;
        return el;
      }

      // Load existing timeslots
      fetch('/get_timeslots')
        .then(r => r.ok ? r.json() : [])
        .then(dataObj => {
          container.innerHTML = '';
          const all = [];
          Object.entries(dataObj).forEach(([day, slots]) => {
            slots.forEach(([s,e]) => all.push({day, start: s, end: e}));
          });
          if (all.length) {
            all.forEach(slot => container.appendChild(makeSlot(slot)));
          } else {
            container.appendChild(makeSlot());
          }
        })
        .catch(_ => {
          container.innerHTML = '';
          container.appendChild(makeSlot());
        });

      // Delete & duplicate
      container.addEventListener('click', e => {
        const slot = e.target.closest('.timeslot');
        if (!slot) return;
        if (e.target.closest('.delete-btn')) slot.remove();
        if (e.target.closest('.duplicate-btn')) {
          const day = slot.querySelector('.day-select').value;
          const start = slot.querySelector('.start-time').value;
          const end = slot.querySelector('.end-time').value;
          daysOfWeek.forEach(d => {
            if (d !== day) container.appendChild(makeSlot({day: d, start, end}));
          });
        }
      });

      // Controls
      document.getElementById('add-slot').addEventListener('click', () => container.appendChild(makeSlot()));
      document.getElementById('clear-all').addEventListener('click', () => container.innerHTML = '');

      // Export JSON
      document.getElementById('export-json').addEventListener('click', () => {
        const data = Array.from(container.children).map(slot => ({
          day: slot.querySelector('.day-select').value,
          start: slot.querySelector('.start-time').value,
          end: slot.querySelector('.end-time').value
        }));
        const blob = new Blob([JSON.stringify(data,null,2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'timeslots.json'; a.click(); URL.revokeObjectURL(url);
      });

      // Import JSON
      const fileInput = document.getElementById('file-input');
      document.getElementById('import-json').addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0]; if (!file) return;
        file.text().then(txt => {
          try {
            const arr = JSON.parse(txt);
            container.innerHTML = '';
            arr.forEach(item => container.appendChild(makeSlot(item)));
          } catch {
            M.toast({html: 'Invalid JSON file', classes: 'red'});
          }
        });
      });

      // Submit slots
      document.getElementById('submit').addEventListener('click', () => {
        const slots = Array.from(container.children).map(slot => ({
          slot,
          day: slot.querySelector('.day-select').value,
          startEl: slot.querySelector('.start-time'),
          endEl: slot.querySelector('.end-time')
        }));
        let bad = false;
        slots.forEach(o => o.slot.classList.remove('invalid'));
        // Validate time ranges
        slots.forEach(({slot, startEl, endEl}) => {
          if (!startEl.value || !endEl.value || endEl.value <= startEl.value) {
            bad = true;
            slot.classList.add('invalid');
          }
        });
        if (bad) return M.toast({html: 'Fix invalid time ranges', classes: 'red'});
        // Check overlaps
        const byDay = {};
        slots.forEach(({slot, day, startEl, endEl}) => {
          byDay[day] = byDay[day] || [];
          byDay[day].push({slot, s: startEl.value, e: endEl.value});
        });
        Object.values(byDay).forEach(arr => {
          arr.sort((a,b) => a.s.localeCompare(b.s));
          for (let i = 1; i < arr.length; i++) {
            if (arr[i].s < arr[i-1].e) {
              bad = true;
              arr[i-1].slot.classList.add('invalid');
              arr[i].slot.classList.add('invalid');
            }
          }
        });
        if (bad) return M.toast({html: 'Found overlapping times', classes: 'red'});
        // Build payload
        const payload = {};
        slots.forEach(({day, startEl, endEl}) => {
          payload[day] = payload[day] || [];
          payload[day].push([startEl.value, endEl.value]);
        });
        fetch('/insert_timeslots', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(_ => { M.toast({html: 'Submitted!', classes: 'green'}); window.location = '/home'; })
        .catch(_ => M.toast({html: 'Submission failed', classes: 'red'}));
      });
    });
  </script>
</body>
</html>
